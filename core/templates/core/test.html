<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>TEST</title>
</head>

<body>
    <textarea id="chat-log" cols="100" rows="20"></textarea><br>
    <input id="start" type="button" value="Start">
    <input id="play" type="button" value="Play">
    <input id="correct" type="button" value="Correct">
    <input id="skip" type="button" value="Skip">
    {{ room_name|json_script:"room-name" }}
    <script>
        function call_api(token, suffix) {
            var req = new XMLHttpRequest();
            req.open("POST", httpUrlPrefix + suffix, false);
            req.setRequestHeader("Authorization", "Token " + token)
            req.send();
            if (req.status !== 200) {
                errorResponse = JSON.parse(req.response);
                document.querySelector('#chat-log').value += (errorResponse["detail"] + '\n');
            }
        }

        const roomPK = JSON.parse(document.getElementById('room-name').textContent);

        const params = new URLSearchParams(window.location.search)

        const token = params.get("token")

        var wsUrl = 'ws://'
            + window.location.host
            + '/ws/'
            + roomPK
            + '/?ticket='
            + params.get("ticket")
            ;
        const chatSocket = new WebSocket(wsUrl);

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            if (data.data.event) {
                document.querySelector('#chat-log').value += ("EVENT: " + data.data.event + '\n');
            } else {
                document.querySelector('#chat-log').value += (data.data.word + '\n');
            }
        };

        chatSocket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly');
        };

        var httpUrlPrefix = "http://" + window.location.host + "/rooms/" + roomPK;
        document.querySelector('#play').onclick = function (e) {
            call_api(token, "/play");
        };
        document.querySelector('#correct').onclick = function (e) {
            call_api(token, "/correct");
        };
        document.querySelector('#skip').onclick = function (e) {
            call_api(token, "/skip");
        };
        document.querySelector('#start').onclick = function (e) {
            call_api(token, "/start");
        };
    </script>
</body>

</html>